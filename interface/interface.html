<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Connect Four</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="style.css">
<script src="http://rawgit.com/ethereum/web3.js/0.16.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethjs@0.3.0/dist/ethjs.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

<script type="text/javascript">
	var abiArray = [
	{
		"constant": false,
		"inputs": [],
		"name": "endGame",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "join",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_col",
				"type": "uint8"
			}
		],
		"name": "setStone",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "withdraw",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "bet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "gameRunning",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getGrid",
		"outputs": [
			{
				"name": "",
				"type": "uint8[6][7]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "lastMatch",
		"outputs": [
			{
				"name": "winner",
				"type": "address"
			},
			{
				"name": "winnings",
				"type": "uint256"
			},
			{
				"name": "nStones",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "maxBet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "minBet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "player1",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "player1Turn",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "player2",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];

	if (typeof web3 !== 'undefined')
	{
	 web3 = new Web3(web3.currentProvider);
	 }
	else
	{
		web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
	 }

	web3.eth.defaultAccount = web3.eth.accounts[0];

	var user = web3.eth.accounts[0];
	var contract = web3.eth.contract(abiArray);
	var c4 = contract.at('0x3f0ed288476c3f8c5544f7f88903fcdc506ca212');


	async function join(val) {
		if (val == -1) {
			val = $("#bet").val()*1e18;
		}
		c4.join({value: val, gas: 800000},function(error, result){
		  if(!error){
		    console.log(result);
		    }
		 else
		   console.error(error);
		 });
	}

	async function playStone(col) {
		c4.setStone(col,function(error, result){
		  if(!error){
		    console.log(result);
		    }
		 else
		   console.error(error);
		 });
	}

	// check if game started
	async function gameRunning() {
	  let promise = new Promise((resolve, reject) => {
	    c4.gameRunning(function(error, result){
		  if(!error){
		  	console.log(result);
		  	resolve(result);
		    } else {
		   	console.error(error);
		   	reject(error);
			}
		 });
	  });

	  let result = await promise;
	  return result;
	}

	// check current turn
	async function player1Turn() {
	  let promise = new Promise((resolve, reject) => {
	    c4.player1Turn(function(error, result){
		  if(!error){
		  	console.log(result);
		  	resolve(result);
		    } else {
		   	console.error(error);
		   	reject(error);
			}
		 });
	  });

	  let result = await promise;
	  return result;
	}

	// Show current turn
	c4.player1Turn(async function(error, result){
	   if(!error) {
	   		var p1t = await player1Turn();
	   		if (p1t) {
	   			$("#priority").html("Next move: <font color=\"red\">Player 1.</font>");
	   		} else {
	   			$("#priority").html("Next move: <font color=\"blue\">Player 2.</font>");
	   		}
	   }
	   else {
	       console.error(error);
	   }
	});

	// get player 2
	c4.player2(function(error, result){
	  if(!error){
	    if (result == '0x0000000000000000000000000000000000000000') {
	  		$("#player2").html('Waiting for Player 2 to join the game...');
	  		$("#priority").hide(); // hide until 2 players present
	  	} else {
	  		$("#player2").html('<font color=\"blue\">Player2: '+result+'</font>');
	    	console.log(result);
		}
	    }
	 else
	   console.error(error);
	 });

	// get player 1
	c4.player1(function(error, result){
	  if(!error){
	  	if (result == '0x0000000000000000000000000000000000000000') {
	  		$("#player1").html('No one has joined the game so far.');
	  		$("#player2").html('');
	  	} else {
	  		$("#player1").html('<font color="red">Player1: '+result+'</font>');
	    	console.log(result);
		}
	    }
	 else
	   console.error(error);
	 });

	// Get bet and create join button
	c4.bet(async function(error, result){
	   if(!error) {
	   		var running = await gameRunning();
	   		if (running == true) {
	   			$("#joinGame").html("Game is currently running. The players each bet "+result/1e18+" ETH on this match.")
	   			return;
	   		} else {
	   			console.log("resbet: "+result);
		       if (result == 0) {
		       	$("#joinGame").append("&nbsp;&nbsp;&nbsp;<a href='javascript:join(-1);'>Enter your bet <strong>IN ETH</strong> and start a new game!<a>");
		       } else {
		       	$("#bet").val("0");
		       	$("#bet").hide();
		       	$("#joinGame").html("<a href='javascript:join("+result+");'>Player 1 bet "+result/1e18+" ether. Match his bet and start the game!<a>");
		       }
	   		}

	   }
	   else {
	       console.error(error);
	   }
	});



	// Draw Grid
	c4.getGrid(function(error, result){
	   if(!error) {
	   		result = result.flat();
	   		var grid = new Array();
	   		for (i=0; i<42; i++) {
	   			grid.push(result[i]["c"][0]);
	   		}
	        var text = "";
			var count = 0;
			for (k = 0; k < 6; k++) {
				for (j = 0; j < 7; j++) {
				count++;
				if (j*6+k <= 5)
					text += "<tr>";

				var playString = " onClick='javascript:playStone("+Math.floor((j*6+k)/6)+");'";
				if (grid[j*6+k] == 0)
					text += "<td><button type=\"button\" "+playString+"></button></td>";
				else if (grid[j*6+k] == 1)
					text += "<td><button type=\"button\" class=\"red\" ></button></td>";
				else
					text += "<td><button type=\"button\" class=\"blue\"></button></td>";

				if (j*6+k >= 36)
					text += "</tr>";
				}
			}
			$("#tableBody").html(text);
	   }
	   else {
	       console.error(error);
	   }
	});

	c4.lastMatch(function(error, result){
	   if(!error) {
	   		console.log(result);
	   		if (result[2] == 42) {
	   			$("#lastMatch").html("Last Match was a draw. Each player won "+result[1]/1e18+".");
	   		} else if(result[2] > 0) {
	   			$("#lastMatch").html("Last Match: "+result[0]+" won "+result[1]/1e18+" ETH after "+result[2]+" moves.");
	   		}
	   }
	   else {
	       console.error(error);
	   }
	});
</script>
</head>
<body>
<section class="wrapper">
<div class="info">
<h1 class="title">Play Connect Four!</h1>
<h2 class="message"><span class="prefix"></span><span id="player" class="player">&nbsp;</span></h2>
<a href="#" class="play-again" style="display: none;">Play Again</a>
<div id="player1"></div>
<div id="player2"></div>
<br>
<div id="joinGame"><input type="number" id="bet" value="0.1" min="0.002" style="width: 5em"></div>
<div id="etherlog"></div>
<br>
<div id="priority"></div>
<br><br>
<table class="board">
<tbody id="tableBody">
</tbody>
</table>
<br><br>
<div id="lastMatch"></div>
</section>
</body>
</html>
